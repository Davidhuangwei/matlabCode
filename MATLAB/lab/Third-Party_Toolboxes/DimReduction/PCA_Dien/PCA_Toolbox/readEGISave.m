function [data, indexdata] = readEGISave(PCAmode, start_samp, last_samp, start_base, last_base, cellList, EGISfile);% readEGISave - [data, indexdata] = readEGISave(PCAmode, start_samp, last_samp, start_base, last_base, cellList, EGISfile) - read in EGIS ave file%Inputs%  PCAmode	: Format for output data ('temp': time points as columns; 'spat': channels as columns)%  start_samp: First time point to be retained in (must include the baseline samples)%  last_samp: Last time points to be included%  start_base: First time point to be included in baseline (set to zero to disable.  This option allows data to be baselined as it is read in).%              Specify baseline points according to start/stop samples (e.g., start-stop samples could be 100 to 250 and baseline could be 100 to 150).%  last_base: Last time points to be included in baseline%  cellList: List of cells to be included.  For example, [1 2 5 6]%  EGISfile	: File ID of the input EGIS file.  If not specified, will provide a requestor window to specify file.%%Outputs%  data		: The data.  See PCAmode for format.%  indexdata: Desciptor of the data rows.  First column is output cell, second is the subject, third is the channel or timepoint.%%History%  Matlab 5.2.1%  by Joseph Dien (9/30/00)%  University of Kansas%  jdien@ku.edu%%  11/26/00 JD%  Celllist feature added so that cells can be dropped before the PCA procedure.%%  12/17/00 JD%  Fixed bugs relating to optional defaults.  Changed to rd_PCAegis_hdr_v to suppress warnings during cell name readings.%%  2/18/01 JD%  Added baseline correction feature.  Added some error detection.%%  5/31/01 Cory Coleman%  Fixed EGISfile argument so if fid is specified, it will be used.%%  5/31/01 JD%  Optimized read speed.  Now assumes all cells will have the same number of samples per trial as cell number one.%%  7/28/01 JD%  Fixed bugs in reading spatial format data.%%  7/31/01 JD%  Fixed bugs when parameters not specified.%%  modified 8/15/01 JD%  Made baseline more flexible and clarified instructions.%%  modified 5/12/03 JD%  Modified celllist feature so that cell numbers are that of the original cell numbers rather than%  the ordinal in the list of retained cells as was previously being done.if nargin < 1  help readEGISave    returnendif nargin < 2  start_samp = 1;endif nargin < 3  last_samp = 0;endif nargin < 4  start_base = 0;endif nargin < 5  last_base = 0;end	if nargin < 7  [fid fname] = get_fid('r');else 							% if the EGISfile arguments is passed it will correctly be assigned to fid  -CC   fid = EGISfile;end[fhdr,chdr,ename,czeros,cgains,cnames,fcom,ftext,coff]=rd_PCAegis_hdr_v(fid);if fhdr(2) == -1  ave_hdr_offsets_v;else  ses_hdr_offsets_v;endcell_data_offsets = get_cell_offsets(fhdr, chdr);if nargin < 6  numCells = fhdr(NCells);  cellList = [1:numCells];else  numCells = size(cellList,2);endif last_samp == 0	last_samp = chdr(1, NSamps);end;if last_samp > chdr(1,NPoints)	error('last sample is specified to be larger than the length of the trials');end;baselength = last_base - start_base+1;if start_base == 0	baselength = 0;end;if baselength < 0 	error('baseline period is less than zero');endnumSamps = last_samp-start_samp+1;numTrials= 0;for cellLoop = 1:numCells	numTrials = numTrials + chdr(1, NObs);end;if PCAmode == 'temp'	numTrials = numTrials * fhdr(NChan);	data = zeros(numTrials,numSamps);elseif PCAmode == 'spat'	numTrials = numTrials * numSamps;	data = zeros(numTrials,fhdr(NChan));else	error('PCAmode must be set to either temp or spat');end;seek_start = 'bof';indexdata = zeros(numTrials,3);currentRow = 0;for cellLoop = 1:numCells	cell=cellList(cellLoop);	cell_data_offset = cell_data_offsets ( cell);		for trialSubj = 1:chdr(cell, NObs)		disp(num2str([cell trialSubj]))		if PCAmode == 'temp'			oneTrData = rd_onetr_allch(fid, cell_data_offset, trialSubj, fhdr(NChan), chdr(cell, NPoints), seek_start, start_samp, last_samp);			if baselength > 0				oneTrData = oneTrData - (ones(size(oneTrData,1),1) * mean(oneTrData(1+start_base-start_samp:last_base-start_samp,:)));			end;			for i = 1:fhdr(NChan)				currentRow = currentRow +1;				data(currentRow,:) = oneTrData(:,i)';				indexdata(currentRow,:) = [cell trialSubj i];			end;		elseif PCAmode == 'spat'			oneTrData = rd_onetr_allch(fid, cell_data_offset, trialSubj, fhdr(NChan), chdr(cell, NPoints), seek_start, start_samp, last_samp);			if baselength > 0				oneTrData = oneTrData - (ones(size(oneTrData,1),1) * mean(oneTrData(1+start_base-start_samp:last_base-start_samp,:)));			end;			for i = 1:numSamps				currentRow = currentRow +1;				data(currentRow,:) = oneTrData(i,:);				indexdata(currentRow,:) = [cell trialSubj i];			end;		end;	end;end;