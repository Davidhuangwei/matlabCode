function avref_trialdata= average_reference(trialdata,mask)%avref_trialdata= average_reference(trialdata,mask)%%average references trial%%Modification history%% written 7/17/95 by RS%% cleaned out a couple of loops and messed with it in the process -- PJ 7/18/99% resized to accommodate new input size of mask - RS size_trial = size(trialdata);NChan = size_trial(2);npoints = size_trial(1);trialdata(:,NChan+1) = zeros(npoints,1);temptrialdata = zeros(npoints,NChan+1);temptrialdata =trialdata.* (ones(size(trialdata,1), 1) * mask);divisor=sum(mask);average=sum(temptrialdata')/divisor;channel=-average';avref_trialdata = temptrialdata + (channel * ones(1, NChan + 1));avref_trialdata=avref_trialdata .* (ones(size(trialdata,1), 1)*mask);